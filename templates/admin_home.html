{% extends "admin_base.html" %}

{% block title %}Dashboard – EsenTrader Admin{% endblock %}

{% block content %}
<div class="page">

  <!-- Üst başlık -->
  <div class="header">
    <div>
      <div class="title">EsenTrader Admin Panel</div>
      <div class="subtitle">Boru API ve IBKR altyapısı için canlı durum ekranı</div>
    </div>
    <div class="mode-pill">
      Mod: <span>{{ mode }}</span>
    </div>
  </div>

  <!-- Üst kartlar -->
  <div class="grid">
    <!-- Boru API kartı -->
    <div class="card">
      <div class="stat-label">Boru API</div>
      <div class="stat-value">
        {% if api_ok %}
          <span class="badge badge-ok"><span class="dot"></span> ONLINE</span>
        {% else %}
          <span class="badge badge-bad"><span class="dot"></span> OFFLINE</span>
        {% endif %}
      </div>
      <div class="card-note">
        <span class="code">127.0.0.1:5055</span><br>
        /api/status yanıtına göre boru API’nin genel durumu.
      </div>
      <button class="btn-primary" onclick="location.href='/admin/status-refresh'">Yenile</button>
    </div>

    <!-- Aktif mod kartı -->
    <div class="card">
      <div class="stat-label">Aktif Mod</div>
      <div class="stat-value">
        <span class="badge badge-neutral">
          {{ mode == "VPS" and "VPS (sunucu aktif)" or "LOCAL (PC üstü aktif)" }}
        </span>
      </div>
      <div class="card-note">
        LOCAL = PC üstü, VPS = uzak sunucu akışı.
      </div>
      <button id="toggleBtn" class="btn-primary">LOCAL / VPS Değiştir</button>
    </div>

    <!-- IBKR durumu kartı -->
    <div class="card">
      <div class="stat-label">IBKR Paneli</div>
      <div class="stat-value">
        <span class="badge badge-neutral">IBKR Durumu</span>
      </div>
      <div class="card-note">
        Detaylı IBKR özet ve pozisyon durumu için özel sayfa.
      </div>
      <button class="btn-primary" onclick="location.href='/admin/ibkr'">IBKR Ekranına Git</button>
    </div>

    <!-- Analytics kartı -->
    <div class="card">
      <div class="stat-label">Analytics</div>
      <div class="stat-value">
        <span class="badge badge-neutral">İstatistik Paneli</span>
      </div>
      <div class="card-note">
        Alarm sayısı, trade hacmi, abone istatistikleri vb.
      </div>
      <button class="btn-primary" onclick="location.href='/admin/analytics'">Analytics Sayfası</button>
    </div>
  </div>

  <!-- API durum JSON alanı -->
  <div class="section">
    <div class="section-title">Boru API Durumu (Detay)</div>
    <div class="section-muted">
      Aşağıdaki JSON, doğrudan <code>/api/status</code> cevabıdır. Boru hattı, versiyon ve mesaj
      bilgilerini buradan görebilirsin.
    </div>
    <pre>{{ api_status_json | tojson(indent=2) }}</pre>
  </div>

  <!-- Servis detay tablosu -->
  <div class="section">
    <div class="section-title">Servis Detayları</div>
    <div class="section-muted">
      Altyapıdaki çekirdek servislerin özet durumu. IBKR durumunu manuel kontrol ediyorsun,
      Boru API ve Admin panel durumu ise otomatik.
    </div>

    <table class="service-table">
      <thead>
        <tr>
          <th>SERVİS</th>
          <th>AÇIKLAMA</th>
          <th>DURUM</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>Boru API</td>
          <td>TradingView sinyalleri ve emir kanallarının ana boru hattı</td>
          <td>
            {% if api_ok %}
              <span class="badge badge-ok"><span class="dot"></span> ONLINE</span>
            {% else %}
              <span class="badge badge-bad"><span class="dot"></span> OFFLINE</span>
            {% endif %}
          </td>
        </tr>
        <tr>
          <td>Admin Panel</td>
          <td>Bu gördüğün ekran (admin_app.py)</td>
          <td><span class="badge badge-ok"><span class="dot"></span> ÇALIŞIYOR</span></td>
        </tr>
        <tr>
          <td>IBKR Gateway</td>
          <td>Windows tarafında çalışan IB Gateway / TWS</td>
          <td><span class="badge badge-neutral"><span class="dot"></span> Manuel Kontrol</span></td>
        </tr>
      </tbody>
    </table>
  </div>

</div>

<script>
  // LOCAL / VPS toggle
  const toggleBtn = document.getElementById("toggleBtn");
  if (toggleBtn) {
    toggleBtn.addEventListener("click", function () {
      const current = "{{ mode }}";
      const next = current === "LOCAL" ? "VPS" : "LOCAL";

      fetch(`/admin/set-mode/${next}`, { method: "POST" })
        .then(r => r.json())
        .then(data => {
          if (data.status === "ok") {
            location.reload();
          } else {
            alert("Mod değiştirme hatası: " + (data.error || "bilinmeyen hata"));
          }
        })
        .catch(err => {
          console.error(err);
          alert("Mod değiştirilirken hata oluştu.");
        });
    });
  }
</script>
{% endblock %}
